apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: deploy
spec:
  params:
    - name: app-name
    - name: image
  steps:
    - name: deploy
      image: registry.redhat.io/openshift4/ose-cli:latest
      script: |
        # Create or update Deployment
        oc apply -n ci-pipeline -f - <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: $(params.app-name)
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: $(params.app-name)
          template:
            metadata:
              labels:
                app: $(params.app-name)
            spec:
              containers:
                - name: $(params.app-name)
                  image: $(params.image)
                  ports:
                    - containerPort: 8080
        EOF

        # Expose service
        oc expose deployment $(params.app-name) -n ci-pipeline --port=8080 --target-port=8080 || true
